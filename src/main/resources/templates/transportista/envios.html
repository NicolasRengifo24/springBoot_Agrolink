<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envíos Disponibles - Agrolink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Inter", sans-serif; background: #f8faf7; overflow-x: hidden; }
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100vh; width: 280px;
            background: linear-gradient(180deg, #2f6b31 0%, #1d4820 100%);
            padding: 20px 0; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar-brand { padding: 0 25px 25px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-brand img { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; border: 2px solid #fff; }
        .sidebar-brand h4 { color: white; font-weight: 700; margin: 0; font-size: 1.5rem; }
        .sidebar-menu { list-style: none; padding: 0; }
        .sidebar-menu li { margin: 5px 15px; }
        .sidebar-menu a {
            display: flex; align-items: center; padding: 14px 18px; color: rgba(255,255,255,0.85);
            text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-weight: 500;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255,255,255,0.15); color: white;
        }
        .sidebar-menu a i { font-size: 1.3rem; margin-right: 15px; width: 25px; }
        .main-content { margin-left: 280px; padding: 25px 30px; min-height: 100vh; }
        .topbar { background: white; padding: 20px 30px; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); margin-bottom: 30px; }
        .topbar h2 { color: #2f6b31; font-weight: 700; margin: 0; }
        .envios-container { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .filter-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f8f0; display: flex; gap: 15px; align-items: center; }
        .envios-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .envio-card {
            background: white; border: 2px solid #f0f8f0; border-radius: 16px; padding: 20px;
            transition: all 0.3s ease; min-height: 400px; display: flex; flex-direction: column;
        }
        .envio-card:hover { border-color: #2f6b31; box-shadow: 0 8px 25px rgba(47, 107, 49, 0.15); }
        .envio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .envio-id { font-size: 1.2rem; font-weight: 700; color: #2f6b31; }
        .envio-status { background: #f0f8f0; color: #2f6b31; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .envio-cliente { margin-bottom: 15px; }
        .envio-cliente-label { font-size: 0.85rem; color: #6c757d; font-weight: 500; margin-bottom: 3px; }
        .envio-cliente-name { font-size: 1rem; font-weight: 600; color: #2f6b31; }
        .envio-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; flex-grow: 1; }
        .detail-item { }
        .detail-label { font-size: 0.75rem; color: #6c757d; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .detail-value { font-size: 0.95rem; font-weight: 600; color: #2f6b31; }
        .envio-costo { margin: 15px 0; padding: 15px; background: #f0f8f0; border-radius: 10px; text-align: center; }
        .envio-costo-label { font-size: 0.85rem; color: #6c757d; margin-bottom: 5px; }
        .envio-costo-value { font-size: 1.8rem; font-weight: 800; color: #2f6b31; }
        .envio-actions { display: flex; gap: 10px; margin-top: auto; }
        .btn-aceptar { flex: 1; background: #2f6b31; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .btn-aceptar:hover { background: #1d4820; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state i { font-size: 4rem; color: #ccc; margin-bottom: 20px; }
        .empty-state h3 { color: #6c757d; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding: 15px; }
            .envios-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-brand d-flex align-items-center">
        <img th:src="@{/CSS/logo/logoAgro.jpeg}" alt="Logo">
        <div>
            <h4>Agrolink</h4>
            <small style="color: rgba(255,255,255,0.7);">Transportista</small>
            <!-- Mostrar nombre de usuario si está disponible -->
            <div style="color: rgba(255,255,255,0.9); margin-top:6px; font-weight:600; font-size:0.95rem;">
                <span th:text="${usuario != null ? (usuario.nombre != null ? usuario.nombre : usuario.nombreUsuario) : ''}"></span>
            </div>
        </div>
    </div>
    <ul class="sidebar-menu">
        <li><a th:href="@{/transportista/envios}" class="active"><i class="bi bi-box-seam"></i><span>Envíos Disponibles</span></a></li>
        <li><a th:href="@{/transportista/mis-envios}"><i class="bi bi-truck"></i><span>Mis Envíos</span></a></li>
        <li><a th:href="@{/transportista/vehiculos}"><i class="bi bi-car-front"></i><span>Mis Vehículos</span></a></li>
        <li><a th:href="@{/transportista/seguimiento}"><i class="bi bi-geo-alt"></i><span>Seguimiento</span></a></li>
        <li><a th:href="@{/transportista/perfil}"><i class="bi bi-person-circle"></i><span>Mi Perfil</span></a></li>
        <!-- Logout -->
        <li><a th:href="@{/logout}"><i class="bi bi-box-arrow-right"></i><span>Cerrar sesión</span></a></li>
     </ul>
</aside>

<main class="main-content">
    <div class="topbar">
        <h2>Envíos Disponibles</h2>
        <p class="text-muted mb-0">Acepta los envíos que mejor se adapten a tu flota</p>
    </div>

    <div class="envios-container">
        <div class="filter-section">
            <span style="color: #6c757d; font-weight: 500;" th:text="'Total: ' + ${envios.size()} + ' envío(s)'">Total: 0 envío(s)</span>
        </div>

        <div th:if="${!envios.isEmpty()}">
            <div class="envios-grid" id="enviosGrid">
                <div class="envio-card" th:each="envio : ${envios}">
                    <div class="envio-header">
                        <div class="envio-id" th:text="'#ENV-' + ${envio.idEnvio}"></div>
                        <span class="envio-status">Disponible</span>
                    </div>

                    <div class="envio-cliente">
                        <div class="envio-cliente-label">Cliente</div>
                        <div class="envio-cliente-name" th:text="${nombresClientes[envio.idEnvio]}">
                            Sin asignar
                        </div>
                    </div>

                    <div class="envio-details">
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-geo-alt"></i> Origen</div>
                            <div class="detail-value" th:text="${envio.direccionOrigen != null ? envio.direccionOrigen : 'N/A'}" style="word-break: break-word; font-size: 0.9rem;"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-geo-alt-fill"></i> Destino</div>
                            <div class="detail-value" th:text="${envio.direccionDestino != null ? envio.direccionDestino : 'N/A'}" style="word-break: break-word; font-size: 0.9rem;"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-rulers"></i> Distancia</div>
                            <div class="detail-value" th:text="${envio.distanciaKm != null ? envio.distanciaKm : '0'}" style="word-break: break-word;"></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label"><i class="bi bi-weight"></i> Peso</div>
                            <div class="detail-value" th:text="${envio.pesoTotalKg != null ? envio.pesoTotalKg : '0'}" style="word-break: break-word;"></div>
                        </div>
                    </div>

                    <div class="envio-costo">
                        <div class="envio-costo-label">Costo del Envío</div>
                        <div class="envio-costo-value" th:if="${envio.costoTotal != null}">$<span th:text="${envio.costoTotal}"></span></div>
                        <div class="envio-costo-value" th:unless="${envio.costoTotal != null}">$0</div>
                    </div>

                    <div class="envio-actions">
                        <button class="btn-aceptar" type="button" th:onclick="'abrirModalAceptarEnvio(' + ${envio.idEnvio} + ')'">
                            <i class="bi bi-check-circle"></i> Aceptar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div th:unless="${!envios.isEmpty()}" class="empty-state">
            <i class="bi bi-inbox"></i>
            <h3>No hay envíos disponibles</h3>
            <p>Por el momento no hay envíos esperando transportista. Vuelve más tarde.</p>
        </div>
    </div>
</main>

<!-- Modal para aceptar envío -->
<div class="modal fade" id="modalAceptarEnvio" tabindex="-1" aria-labelledby="modalAceptarEnvioLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAceptarEnvioLabel">Aceptar Envío</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="formAceptarEnvio">
        <div class="modal-body">
          <input type="hidden" id="modalEnvioId" name="envioId">
          <div class="mb-3">
            <label for="vehiculoId" class="form-label">Selecciona un vehículo</label>
            <select class="form-select" id="vehiculoId" name="vehiculoId" required>
              <option value="" disabled selected>Selecciona...</option>
              <th:block th:each="vehiculo : ${vehiculos}">
                <option th:value="${vehiculo.idVehiculo}" th:text="${vehiculo.placaVehiculo} + ' - ' + ${vehiculo.tipoVehiculo}"></option>
              </th:block>
            </select>
          </div>
          <div class="mb-3">
            <label for="fechaSalida" class="form-label">Fecha de salida</label>
            <input type="date" class="form-control" id="fechaSalida" name="fechaSalida" required min="2025-12-12">
          </div>
          <div class="mb-3">
            <label for="fechaEntrega" class="form-label">Fecha de entrega</label>
            <input type="date" class="form-control" id="fechaEntrega" name="fechaEntrega" required min="2025-12-12">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Aceptar Envío</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Formatear números en las tarjetas
document.addEventListener('DOMContentLoaded', function() {
    const detailValues = document.querySelectorAll('.envio-details .detail-value');
    detailValues.forEach((element, index) => {
        const label = element.previousElementSibling.textContent.toLowerCase();
        let valor = element.textContent.trim();

        if (label.includes('distancia')) {
            valor = parseFloat(valor).toFixed(2);
            element.textContent = valor + ' km';
        } else if (label.includes('peso')) {
            valor = parseFloat(valor).toFixed(2);
            element.textContent = valor + ' kg';
        }
    });
});

function abrirModalAceptarEnvio(idEnvio) {
    document.getElementById('modalEnvioId').value = idEnvio;
    document.getElementById('vehiculoId').selectedIndex = 0;
    document.getElementById('fechaSalida').value = '';
    document.getElementById('fechaEntrega').value = '';
    var modal = new bootstrap.Modal(document.getElementById('modalAceptarEnvio'));
    modal.show();
}

document.getElementById('formAceptarEnvio').addEventListener('submit', function(e) {
    e.preventDefault();
    const envioId = document.getElementById('modalEnvioId').value;
    const vehiculoId = document.getElementById('vehiculoId').value;
    const fechaSalida = document.getElementById('fechaSalida').value;
    const fechaEntrega = document.getElementById('fechaEntrega').value;
    if (!vehiculoId || !fechaSalida || !fechaEntrega) {
        alert('Debes seleccionar un vehículo, una fecha de salida y una fecha de entrega.');
        return;
    }
    fetch('/transportista/envios/aceptar/' + envioId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ vehiculoId, fechaSalida, fechaEntrega })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('✅ Envío aceptado correctamente');
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('❌ ' + data.message);
        }
    })
    .catch(() => alert('❌ Error al aceptar el envío'));
});
</script>

</body>
</html>
