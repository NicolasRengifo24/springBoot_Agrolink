<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Envíos - Agrolink</title>

    <link rel="stylesheet" th:href="@{/CSS/fragments-styles/sidebar.css}">
    <link rel="stylesheet" th:href="@{/CSS/vistas-style/transportista.css}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <!-- CSRF tokens para peticiones AJAX -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

</head>
<body>

<div th:replace ="fragments/transportista-sidebar::transportistaSidebar('seguimiento')"> </div>

<main class="main-content">
    <div class="topbar">
        <h2>Seguimiento de Envíos</h2>
        <p class="text-muted mb-0">Monitorea el estado de tus envíos en tiempo real</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" data-stat="enTransito" th:text="${enTransito}">0</div>
            <div class="stat-text">En Tránsito</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" data-stat="pendientes" th:text="${pendientes}">0</div>
            <div class="stat-text">Asignados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" data-stat="finalizados" th:text="${finalizados}">0</div>
            <div class="stat-text">Finalizados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" data-stat="tasaEntrega" th:text="${tasaEntrega + '%'}">0%</div>
            <div class="stat-text">Tasa de Entrega</div>
        </div>
    </div>

    <div class="container-seguimiento">
        <h5 style="color: #2f6b31; margin-bottom: 20px;">Envíos en Proceso</h5>

        <div th:if="${!envios.isEmpty()}">
            <div th:each="envio : ${envios}" class="envio-item" th:attr="data-envio-id=${envio.idEnvio}">
                <div class="envio-item-header">
                    <div class="envio-id" th:text="'#ENV-' + ${envio.idEnvio}">#ENV-0</div>
                    <span class="envio-status" th:classappend="${envio.estadoEnvio == 'En_Transito' ? 'status-transito' : (envio.estadoEnvio == 'Finalizado' ? 'status-finalizado' : 'status-asignado')}" th:text="${envio.estadoEnvio}">Estado</span>
                </div>

                <!-- Botones para cambiar estado -->
                <div class="mb-2">
                    <form th:action="@{'/transportista/envios/actualizar-estado/' + ${envio.idEnvio}}" method="post" class="ajax-estado-form" style="display:inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="estado" value="En_Transito" />
                        <button type="submit" class="btn btn-sm btn-primary me-2" th:if="${envio.estadoEnvio.name() == 'Asignado'}">
                            Marcar como En Tránsito
                        </button>
                    </form>
                    <form th:action="@{'/transportista/envios/actualizar-estado/' + ${envio.idEnvio}}" method="post" class="ajax-estado-form" style="display:inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="estado" value="Finalizado" />
                        <button type="submit" class="btn btn-sm btn-success" th:if="${envio.estadoEnvio.name() == 'En_Transito' || envio.estadoEnvio.name() == 'Asignado'}">
                            Marcar como Finalizado
                        </button>
                    </form>
                    <!-- Botón para cancelar el envío: devuelve el envío a Buscando_Transporte y limpia asignaciones -->
                    <form th:action="@{'/transportista/envios/actualizar-estado/' + ${envio.idEnvio}}" method="post" class="ajax-estado-form" style="display:inline;" onsubmit="return confirm('¿Estás seguro de cancelar este envío? Esto lo dejará nuevamente buscando transportista.');">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="estado" value="Buscando_Transporte" />
                        <button type="submit" class="btn btn-sm btn-danger ms-2" th:if="${envio.estadoEnvio.name() == 'Asignado' || envio.estadoEnvio.name() == 'En_Transito'}">
                            Cancelar envío
                        </button>
                    </form>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <small style="color: #6c757d;">Origen</small>
                        <p style="margin: 0; font-weight: 600;" th:text="${envio.direccionOrigen != null ? #strings.abbreviate(envio.direccionOrigen, 50) : 'N/A'}">Origen</p>
                    </div>
                    <div class="col-md-6">
                        <small style="color: #6c757d;">Destino</small>
                        <p style="margin: 0; font-weight: 600;" th:text="${envio.direccionDestino != null ? #strings.abbreviate(envio.direccionDestino, 50) : 'N/A'}">Destino</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <small style="color: #6c757d;">Distancia</small>
                        <p style="margin: 0; font-weight: 600;" th:text="${envio.distanciaKm != null ? #numbers.formatDecimal(envio.distanciaKm, 0, 'POINT', 1, 'COMMA') + ' km' : 'N/A'}">0 km</p>
                    </div>
                    <div class="col-md-3">
                        <small style="color: #6c757d;">Peso</small>
                        <p style="margin: 0; font-weight: 600;" th:text="${envio.pesoTotalKg != null ? #numbers.formatDecimal(envio.pesoTotalKg, 0, 'POINT', 0, 'COMMA') + ' kg' : 'N/A'}">0 kg</p>
                    </div>
                    <div class="col-md-3">
                        <small style="color: #6c757d;">Costo</small>
                        <p style="margin: 0; font-weight: 600;">$<span th:text="${envio.costoTotal != null ? #numbers.formatDecimal(envio.costoTotal, 0, 'POINT', 0, 'COMMA') : '0'}">0</span></p>
                    </div>
                    <div class="col-md-3">
                        <small style="color: #6c757d;">Cliente</small>
                        <p style="margin: 0; font-weight: 600;" th:text="${envio.compra != null && envio.compra.cliente != null ? envio.compra.cliente.usuario.nombre : 'N/A'}">Cliente</p>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${envios.isEmpty()}" class="empty-state">
            <i class="bi bi-geo-alt"></i>
            <h3>No tienes envíos en proceso</h3>
            <p>Los envíos que aceptes aparecerán aquí para seguimiento</p>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Toast simple y lógica AJAX para evitar navegación completa al actualizar estado -->
<style>
    #ajaxToast {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 220px;
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        display: none;
        z-index: 1060;
        color: #fff;
    }
    #ajaxToast.success { background: #28a745; }
    #ajaxToast.error { background: #dc3545; }
</style>
<div id="ajaxToast" role="status" aria-live="polite"></div>
<script>
    (function(){
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        function showToast(message, type='success'){
            const toast = document.getElementById('ajaxToast');
            toast.textContent = message;
            toast.className = '';
            toast.classList.add(type);
            toast.style.display = 'block';
            setTimeout(()=>{ toast.style.display = 'none'; }, 3500);
        }

        async function handleSubmit(e){
            e.preventDefault();
            const form = e.target;
            if(!form.classList.contains('ajax-estado-form')) return;

            // Si el formulario tiene un onsubmit con confirm(...), ejecutar la confirmación manualmente
            if(form.hasAttribute('onsubmit')){
                const onsubmitAttr = form.getAttribute('onsubmit');
                if(onsubmitAttr && onsubmitAttr.includes('confirm')){
                    const m = onsubmitAttr.match(/confirm\(['\"](.+?)['\"]\)/);
                    const msg = m ? m[1] : '¿Estás seguro?';
                    if(!window.confirm(msg)) return; // el usuario canceló
                }
            }

            const url = form.getAttribute('action');
            const formData = new FormData(form);
            const body = new URLSearchParams();
            for(const pair of formData.entries()) body.append(pair[0], pair[1]);

            try{
                const headers = {
                    'X-Requested-With': 'XMLHttpRequest'
                };
                if(csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;
                headers['Content-Type'] = 'application/x-www-form-urlencoded';

                const resp = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: body.toString()
                });

                if(!resp.ok){
                    const text = await resp.text();
                    showToast('Error al actualizar estado', 'error');
                    console.error('Error response', resp.status, text);
                    return;
                }

                const data = await resp.json();
                if(data && data.success){
                    showToast(data.message || 'Estado actualizado', 'success');

                    // Usar nuevoEstado y prevEstado devueltos por el backend si existen
                    const nuevoEstado = data.nuevoEstado || form.querySelector('input[name="estado"]').value;
                    const prevEstadoResp = data.prevEstado || null;

                    // Actualizar UI: manejar cambios en la vista sin recargar
                    const envioItem = form.closest('.envio-item');

                    // Si el envío vuelve a "Buscando_Transporte" o se finaliza, lo removemos (no pertenece a seguimiento)
                    if(nuevoEstado === 'Buscando_Transporte' || nuevoEstado === 'Finalizado'){
                        if(envioItem) envioItem.remove();

                        // actualizar contadores usando prevEstadoResp
                        updateCounters(prevEstadoResp, nuevoEstado);
                    } else {
                        // Actualizar texto y clases del estado
                        if(envioItem){
                            const statusEl = envioItem.querySelector('.envio-status');
                            if(statusEl) statusEl.textContent = nuevoEstado;
                            if(statusEl){
                                statusEl.classList.remove('status-transito','status-finalizado','status-asignado');
                                if(nuevoEstado === 'En_Transito') statusEl.classList.add('status-transito');
                                else if(nuevoEstado === 'Finalizado') statusEl.classList.add('status-finalizado');
                                else statusEl.classList.add('status-asignado');
                                // guardar previo para futuras transiciones
                                if(prevEstadoResp) statusEl.setAttribute('data-prev-estado', prevEstadoResp);
                            }

                            // Actualizar visibilidad de los formularios según el nuevo estado
                            const forms = envioItem.querySelectorAll('.ajax-estado-form');
                            forms.forEach(f => {
                                const valueInput = f.querySelector('input[name="estado"]');
                                const formEstado = valueInput ? valueInput.value : null;

                                // Si el formulario corresponde al estado recién aplicado, ocultarlo
                                if(formEstado === nuevoEstado){
                                    f.style.display = 'none';
                                } else {
                                    f.style.display = 'inline';
                                }
                            });

                            // Asegurar que el botón 'Marcar como En Tránsito' desaparezca cuando aplicamos En_Transito
                            const enTransitoForm = envioItem.querySelector('form.ajax-estado-form input[name="estado"][value="En_Transito"]');
                            if(enTransitoForm){
                                const f = enTransitoForm.closest('form');
                                if(f){
                                    if(nuevoEstado === 'En_Transito') f.style.display = 'none';
                                    else f.style.display = 'inline';
                                }
                            }

                            // Actualizar contadores usando prevEstadoResp si está disponible
                            updateCounters(prevEstadoResp, nuevoEstado);
                        }
                    }

                 } else {
                     showToast(data.message || 'No se pudo actualizar', 'error');
                 }

            }catch(err){
                console.error(err);
                showToast('Error de red', 'error');
            }
        }

        // Delegación de eventos: interceptar submit para formularios con clase .ajax-estado-form
        document.addEventListener('submit', function(e){
            if(e.target && e.target.classList && e.target.classList.contains('ajax-estado-form')){
                handleSubmit(e);
            }
        });

        // Helper para actualizar contadores en la parte superior con precisión usando prevEstado y nuevoEstado
        function updateCounters(prevEstado, nuevoEstado){
            try{
                const enTransitoEl = document.querySelector('[data-stat="enTransito"]');
                const pendientesEl = document.querySelector('[data-stat="pendientes"]');
                const finalizadosEl = document.querySelector('[data-stat="finalizados"]');

                const parse = el => el ? parseInt(el.textContent.replace('%','')) || 0 : 0;
                let enT = parse(enTransitoEl);
                let pen = parse(pendientesEl);
                let fin = parse(finalizadosEl);

                // Decrementar contador del prevEstado
                if(prevEstado === 'En_Transito') enT = Math.max(0, enT - 1);
                else if(prevEstado === 'Asignado') pen = Math.max(0, pen - 1);
                else if(prevEstado === 'Finalizado') fin = Math.max(0, fin - 1);

                // Incrementar contador del nuevoEstado cuando aplique
                if(nuevoEstado === 'En_Transito') enT = enT + 1;
                else if(nuevoEstado === 'Asignado') pen = pen + 1;
                else if(nuevoEstado === 'Finalizado') fin = fin + 1;

                if(enTransitoEl) enTransitoEl.textContent = enT;
                if(pendientesEl) pendientesEl.textContent = pen;
                if(finalizadosEl) finalizadosEl.textContent = fin;
            }catch(e){
                console.debug('No se pudo actualizar contadores dinámicamente', e);
            }
        }
    })();
</script>
</body>
</html>
