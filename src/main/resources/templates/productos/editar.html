<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Editar Producto — Agrolink Premium</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root{--green: #2f6b31;} body{font-family:Arial,Helvetica,sans-serif;background:#f8faf7;color:#222} .container-main{max-width:1000px;margin:40px auto;padding:20px;} .card-glass{background:white;border-radius:20px;padding:22px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 12px 26px rgba(0,0,0,0.06);} 
  </style>
</head>
<body>
  <div class="container-main">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0" style="color:var(--green);">Editar producto</h3>
        <div class="small text-muted">Agrolink — Productor</div>
      </div>
      <div>
        <a th:href="@{/productos}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Volver</a>
      </div>
    </div>

    <div class="card-glass">
      <form th:action="@{/productos/actualizar/{id}(id=${producto.idProducto})}" th:object="${producto}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="id" th:value="${producto.idProducto}" />

        <div class="row g-3">

          <div class="col-md-6">
            <label class="form-label" for="nombreProducto">Nombre *</label>
            <input id="nombreProducto" class="form-control" th:field="*{nombreProducto}" required/>
          </div>

          <div class="col-md-6">
            <label class="form-label" for="categoriaId">Categoría *</label>
            <select id="categoriaId" th:field="*{categoria.idCategoria}" class="form-select" required>
              <option value="">Seleccione una categoría</option>
              <option th:each="categoria : ${categorias}"
                      th:value="${categoria.idCategoria}"
                      th:text="${categoria.nombreCategoria}">Categoría</option>
            </select>
          </div>

          <div class="col-12">
            <label class="form-label" for="descripcionProducto">Descripción</label>
            <textarea id="descripcionProducto" class="form-control" th:field="*{descripcionProducto}" rows="3"></textarea>
          </div>

          <div class="col-md-4">
            <label class="form-label" for="stock">Stock *</label>
            <input id="stock" type="number" th:field="*{stock}" class="form-control" min="0" required/>
          </div>

          <div class="col-md-4">
            <label class="form-label" for="precio">Precio (COP) *</label>
            <input id="precio" type="number" th:field="*{precio}" class="form-control" min="0" step="0.01" required/>
          </div>

          <div class="col-md-4">
            <label class="form-label" for="pesoKg">Peso (Kg)</label>
            <input id="pesoKg" type="number" th:field="*{pesoKg}" class="form-control" min="0" step="0.01"/>
          </div>

          <div class="col-md-6">
            <label class="form-label" for="productorId">Productor *</label>
            <select id="productorId" th:field="*{productor.idProductor}" class="form-select" required onchange="cargarFincasDeProductor(this.value)">
              <option value="">Seleccione un productor</option>
              <option th:each="productor : ${productores}"
                      th:value="${productor.idProductor}"
                      th:text="${productor.usuario != null ? productor.usuario.nombreUsuario : 'Productor ID: ' + productor.idProductor}">Productor</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label" for="fincaIds">Finca(s) donde se produce</label>
            <select id="fincaIds" name="fincaIds" class="form-select" multiple size="3">
              <option value="">Cargando fincas...</option>
            </select>
            <small class="form-text text-muted">
              <i class="bi bi-info-circle"></i> Mantén presionado Ctrl (Cmd en Mac) para seleccionar múltiples fincas
            </small>
          </div>

          <div class="col-md-12">
            <label class="form-label" for="imagenFile">Cambiar Imagen</label>
            <input id="imagenFile" type="file" name="imagenFile" class="form-control" accept="image/*"/>
            <input type="hidden" name="esPrincipal" value="true"/>
          </div>

          <div class="col-12">
            <img th:if="${producto.imagenesProducto != null and !#lists.isEmpty(producto.imagenesProducto)}"
                 th:src="@{${producto.imagenesProducto[0].urlImagen}}"
                 alt="Vista previa" width="160" class="mt-2" style="border-radius:12px;border:1px solid #ccc;">
            <img th:if="${producto.imagenesProducto == null or #lists.isEmpty(producto.imagenesProducto)}"
                 th:src="@{/imag/placeholder.jpg}"
                 alt="Vista previa" width="160" class="mt-2" style="border-radius:12px;border:1px solid #ccc;">
          </div>

          <div class="col-12 text-end mt-2">
            <a th:href="@{/productos}" class="btn btn-outline-secondary">Cancelar</a>
            <button class="btn btn-success" type="submit">Guardar cambios</button>
          </div>

        </div>
      </form>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script th:inline="javascript">
    // ============================================
    // CARGAR FINCAS AL CARGAR LA PÁGINA
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        const productorId = document.getElementById('productorId').value;
        if (productorId) {
            cargarFincasDeProductor(productorId);
        }
    });

    // ============================================
    // CARGAR FINCAS DEL PRODUCTOR SELECCIONADO
    // ============================================
    function cargarFincasDeProductor(productorId) {
        const fincaSelect = document.getElementById('fincaIds');

        if (!productorId || productorId === '') {
            fincaSelect.innerHTML = '<option value="">Primero seleccione un productor</option>';
            return;
        }

        fincaSelect.innerHTML = '<option value="">Cargando fincas...</option>';

        fetch('/productos/fincas/por-productor/' + productorId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar las fincas');
                }
                return response.json();
            })
            .then(fincas => {
                fincaSelect.innerHTML = '';

                if (!fincas || fincas.length === 0) {
                    fincaSelect.innerHTML = '<option value="">Este productor no tiene fincas registradas</option>';
                    return;
                }

                // Obtener fincas ya asociadas al producto
                const fincasAsociadas = /*[[${producto.productoFincas}]]*/ [];
                const fincasAsociadasIds = fincasAsociadas.map(pf => pf.finca ? pf.finca.idFinca : null);

                // Llenar el selector con las fincas del productor
                fincas.forEach(finca => {
                    const option = document.createElement('option');
                    option.value = finca.idFinca;
                    option.textContent = finca.nombreFinca + ' (' + finca.ciudad + ', ' + finca.departamento + ')';

                    // Marcar como seleccionada si ya está asociada
                    if (fincasAsociadasIds.includes(finca.idFinca)) {
                        option.selected = true;
                    }

                    fincaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                fincaSelect.innerHTML = '<option value="">Error al cargar fincas</option>';
                alert('Error al cargar las fincas del productor. Por favor intente nuevamente.');
            });
    }
  </script>
</body>
</html>
