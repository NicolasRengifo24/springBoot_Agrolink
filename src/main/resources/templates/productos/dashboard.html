<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Productor — Agrolink Premium</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Stub temprano para evitar ReferenceError si hay onclick inline antes de cargar el script principal -->
  <script>
    // Si se llama antes de que el script principal esté listo, guardamos la sección pendiente
    window.cambiarSeccion = function(seccion) {
      window.__pending_cambiarSeccion = seccion;
    };
  </script>

  <style>
    :root{
      --green: #2f6b31;
      --green-light: #3f8a41;
      --muted: #7e8b7e;
      --glass: rgba(255,255,255,0.75);
    }

    body{
      font-family: "Inter", sans-serif;
      background: linear-gradient(180deg,#f8faf7,#f1f4ef);
      color:#222;
    }

    /* GRID LAYOUT */
    .app{
      display:grid;
      grid-template-columns:260px 1fr;
      gap:30px;
      max-width:1450px;
      margin:40px auto;
      padding:0 20px;
    }

    /* SIDEBAR */
    .sidebar{
      background:var(--glass);
      backdrop-filter:blur(12px);
      border-radius:20px;
      border:1px solid rgba(0,0,0,0.05);
      height:calc(100vh - 80px);
      padding:20px;
      position:sticky;
      top:40px;
      transition:.25s;
    }

    .sidebar.collapsed{
      width:76px;
      padding:20px 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:22px;
    }

    .brand img{
      width:42px;
      height:42px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--green);
      display:block;
      background:#fff;
    }

    .brand-title{
      font-weight:800;
      color:var(--green);
      font-size:1.3rem;
    }

    .nav-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      margin-bottom:6px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:.2s;
    }

    .nav-item:hover{
      background:rgba(47,107,49,0.07);
      transform:translateX(4px);
    }

    .nav-item.active{
      background:var(--green);
      color:white;
      box-shadow:0 8px 18px rgba(47,107,49,0.25);
    }

    .nav-item .bi{
      font-size:1.1rem;
      color:var(--green);
    }

    .nav-item.active .bi{
      color:white;
    }

    .sidebar.collapsed .nav-label{
      display:none;
    }

    /* TOPBAR */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      gap:10px;
    }

    .searchbar{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 18px;
      border-radius:16px;
      background:white;
      border:1px solid #e3e9e2;
      box-shadow:0 4px 14px rgba(0,0,0,0.05);
    }

    /* CARD GLASS */
    .card-glass{
      background:white;
      border-radius:20px;
      padding:22px;
      border:1px solid rgba(0,0,0,0.05);
      box-shadow:0 12px 26px rgba(0,0,0,0.06);
      margin-bottom:20px;
    }

    /* KPIs */
    .kpi{
      padding:20px;
      border-radius:16px;
      background:white;
      box-shadow:0 8px 18px rgba(0,0,0,0.05);
      border:1px solid #edf2ec;
      transition:.2s;
    }
    .kpi:hover{
      transform:translateY(-4px);
      box-shadow:0 12px 26px rgba(0,0,0,0.09);
    }

    .kpi-icon{
      font-size:2rem;
      color:var(--green);
    }

    .kpi-number{
      font-size:1.9rem;
      font-weight:700;
    }

    .kpi-label{
      color:var(--muted);
      font-size:.9rem;
    }

    /* TABLE */
    table img.thumb{
      width:58px;
      height:58px;
      border-radius:10px;
      object-fit:cover;
      object-position:center;
      border:1px solid #eee;
      display:block;
    }


    /* FAB */
    .fab{
      position:fixed;
      right:40px;
      bottom:40px;
      width:70px;
      height:70px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--green),var(--green-light));
      border:none;
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.7rem;
      box-shadow:0 12px 30px rgba(47,107,49,0.28);
      cursor:pointer;
      transition:.2s;
    }
    .fab:hover{
      transform:translateY(-7px) scale(1.03);
    }

    /* ANIMATIONS */
    .fade{
      animation:fadeUp .4s ease both;
    }
    @keyframes fadeUp{
      from{opacity:0;transform:translateY(14px);}
      to{opacity:1;transform:translateY(0);}
    }

    .alert-custom {
      border-radius: 12px;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>

  <div class="app">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar">

      <div class="d-flex justify-content-between align-items-center">
        <div class="brand">
          <img th:src="@{/CSS/logo/logoAgrolink.jpeg}"
               alt="Logo Agrolink"
               style="width:42px; height:42px; border-radius:50%; object-fit:cover; border:2px solid var(--green);"
               onerror="this.style.display='none';">
          <div>
            <div class="brand-title">Agrolink</div>
            <div class="small text-muted">Productor</div>
            <div class="fw-bold mt-1" style="color:var(--green);" th:text="${usuarioLogueado}"></div>
          </div>
        </div>

        <button id="btnToggle" class="btn btn-light btn-sm">
          <i class="bi bi-list"></i>
        </button>
      </div>

      <nav>
        <div class="nav-item active" data-section="productos" onclick="cambiarSeccion('productos')">
          <i class="bi bi-box-seam"></i><span class="nav-label"> Productos</span>
        </div>
        <div class="nav-item" data-section="pedidos" onclick="cambiarSeccion('pedidos')">
          <i class="bi bi-receipt"></i><span class="nav-label"> Pedidos</span>
        </div>
        <!-- Botón Cerrar sesión -->
        <form th:action="@{/logout}" method="post" style="margin:0;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="nav-item nav-logout" style="background:none;border:none;width:100%;text-align:left;padding:12px;border-radius:12px;">
            <i class="bi bi-box-arrow-right" style="color:#d9534f"></i>
            <span class="nav-label" style="color:#d9534f;margin-left:12px;">Cerrar sesión</span>
          </button>
        </form>
       </nav>

    </aside>

    <!-- MAIN CONTENT -->
    <main>

      <!-- TOPBAR -->
      <div class="topbar">

        <div class="searchbar">
          <i class="bi bi-search fs-5 text-muted"></i>
          <label for="searchBox" class="visually-hidden">Buscar producto</label>
          <input id="searchBox" class="form-control border-0" placeholder="Buscar producto..."/>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary"><i class="bi bi-bell"></i></button>
          <img src="https://i.pravatar.cc/40?img=12" alt="Perfil de usuario" class="rounded-circle" width="40">
        </div>

      </div>

      <!-- ALERTAS -->
      <div th:if="${success}" class="alert alert-success alert-custom alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:switch="${success}">
          <span th:case="'created'">Producto creado exitosamente</span>
          <span th:case="'updated'">Producto actualizado exitosamente</span>
          <span th:case="'deleted'">Producto eliminado exitosamente</span>
          <span th:case="*" th:text="${success}">Operación exitosa</span>
        </span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <div th:if="${error}" class="alert alert-danger alert-custom alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:switch="${error}">
          <span th:case="'delete_failed'">Error al eliminar el producto</span>
          <span th:case="'update_failed'">Error al actualizar el producto</span>
          <span th:case="'has_orders'">No se puede eliminar: el producto tiene pedidos asociados</span>
          <span th:case="*" th:text="${error}">Error en la operación</span>
        </span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <!-- ============================================ -->
      <!-- SECCIÓN PRODUCTOS (visible por defecto)    -->
      <!-- ============================================ -->
      <div id="seccionProductos">
        <!-- KPIs -->
        <div class="row g-3 mb-4 fade">
          <div class="col-md-3">
            <div class="kpi">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="kpi-number" th:text="${productos.size()}">0</div>
                  <div class="kpi-label">Productos</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-box-seam-fill"></i></div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="kpi">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="kpi-number" th:text="${fincas.size()}">0</div>
                  <div class="kpi-label">Fincas</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-geo-alt-fill"></i></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div th:if="${productos.isEmpty()}">
          <div class="alert alert-info">Aún no tienes productos registrados. ¡Agrega tu primer producto!</div>
          <a th:href="@{/productor/crear}" class="btn btn-success mb-3"><i class="bi bi-plus-circle me-1"></i>Agregar Producto</a>
        </div>
        <div th:if="${!productos.isEmpty()}">
          <!-- Botón 'Ver todos los productos' eliminado por petición del usuario -->
       </div>

        <!-- Fincas -->
        <div th:if="${fincas.isEmpty()}">
          <div class="alert alert-info">Aún no tienes fincas registradas. ¡Agrega tu primera finca!</div>
          <a th:href="@{/fincas/crear}" class="btn btn-success mb-3"><i class="bi bi-plus-circle me-1"></i>Agregar Finca</a>
        </div>
        <div th:if="${!fincas.isEmpty()}">
          <a th:href="@{/fincas/lista}" class="btn btn-outline-primary mb-3">Ver todas las fincas</a>
        </div>

        <!-- PRODUCTOS -->
        <div class="card-glass fade">
          <div class="d-flex justify-content-between">
            <h5>Mis Productos</h5>
            <!-- Enlace a la página de creación separada -->
            <a th:href="@{/productor/crear}" class="btn btn-success">
              <i class="bi bi-plus-lg"></i> Crear producto
            </a>
          </div>

          <div class="table-responsive mt-3">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Producto</th>
                  <th>Categoría</th>
                  <th>Finca(s)</th>
                  <th>Stock</th>
                  <th>Precio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="producto : ${productos}">
                  <td>
                    <!-- Mostrar imagen principal si existe, o placeholder si no -->
                    <img class="thumb"
                         th:alt="${producto.nombreProducto}"
                         th:src="${producto.imagenesProducto != null and !producto.imagenesProducto.isEmpty() ? producto.imagenesProducto[0].urlImagen : '/imag/placeholder.jpg'}"
                         onerror="this.onerror=null; this.src='/imag/placeholder.jpg';" />
                  </td>
                  <td>
                    <strong th:text="${producto.nombreProducto}">Nombre</strong><br>
                    <small class="text-muted" th:text="${'ID: ' + producto.idProducto}">ID: 1</small>
                  </td>
                  <td th:text="${producto.categoria != null ? producto.categoria.nombreCategoria : 'Sin categoría'}">Categoría</td>
                  <td>
                    <!-- Mostrar fincas asociadas -->
                    <th:block th:if="${producto.productoFincas != null and #lists.size(producto.productoFincas) > 0}">
                      <th:block th:each="pf, iterStat : ${producto.productoFincas}">
                        <span th:if="${iterStat.index < 2 and pf != null and pf.finca != null}"
                              class="badge bg-success-subtle text-success me-1 mb-1"
                              th:text="${pf.finca.nombreFinca}"
                              th:title="${pf.finca.nombreFinca}">
                          Finca
                        </span>
                      </th:block>
                      <span th:if="${#lists.size(producto.productoFincas) > 2}"
                            class="badge bg-secondary-subtle text-secondary">
                        + más
                      </span>
                    </th:block>
                    <small class="text-muted" th:if="${producto.productoFincas == null or #lists.size(producto.productoFincas) == 0}">
                      <i class="bi bi-dash-circle"></i> Sin finca
                    </small>
                  </td>
                  <td th:text="${producto.stock}">0</td>
                  <td>
                    <strong th:text="${#numbers.formatCurrency(producto.precio)}">$0</strong>
                  </td>
                  <td class="text-end">
                    <!-- Botón que abre modal para editar sin navegar fuera -->
                    <button type="button" class="btn btn-sm btn-outline-primary me-1" title="Editar"
                            th:attr="onclick=|abrirModalEditar(${producto.idProducto})|">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <form th:action="@{/productos/eliminar/{id}(id=${producto.idProducto})}"
                          method="post"
                          style="display:inline;"
                          onsubmit="return confirm('¿Está seguro de eliminar este producto?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </button>
                    </form>
                  </td>
                </tr>

                <tr th:if="${productos == null || productos.isEmpty()}">
                  <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No hay productos registrados. Crea tu primer producto.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECCIÓN PEDIDOS (oculta inicialmente)      -->
      <!-- ============================================ -->
      <div id="seccionPedidos" style="display:none;">
        <div class="card-glass fade">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Pedidos recibidos</h5>
            <button class="btn btn-outline-secondary btn-sm" onclick="cargarPedidos()">
              <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
          </div>

          <div id="pedidosLoading" class="text-center py-5" style="display:none;">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando pedidos...</p>
          </div>

          <div class="table-responsive" id="tablaPedidos">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Fecha</th>
                  <th>Dirección</th>
                  <th>Total</th>
                  <th>Método Pago</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="pedidosTableBody">
                <!-- Se llenará dinámicamente con JavaScript -->
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    Haz clic en "Actualizar" para cargar los pedidos.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECCIÓN FINCAS (oculta inicialmente)       -->
      <!-- ============================================ -->
      <div id="seccionFincas" style="display:none;">
        <div class="card-glass fade">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Mis Fincas</h5>
            <button class="btn btn-success btn-sm" onclick="mostrarFormularioFinca()">
              <i class="bi bi-plus-lg"></i> Agregar Finca
            </button>
          </div>

          <!-- Formulario de Nueva Finca (oculto inicialmente) -->
          <div id="formularioFinca" style="display:none;" class="mb-4">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Nueva Finca</h6>
              </div>
              <div class="card-body">
                <form id="formCrearFinca">
                  <div class="row g-3">
                    <!-- Nombre de la Finca -->
                    <div class="col-md-6">
                      <label for="nombreFinca" class="form-label">Nombre de la Finca *</label>
                      <input type="text" class="form-control" id="nombreFinca" name="nombreFinca" required
                             placeholder="Ej: Finca El Paraíso">
                    </div>

                    <!-- Departamento -->
                    <div class="col-md-3">
                      <label for="departamento" class="form-label">Departamento *</label>
                      <input type="text" class="form-control" id="departamento" name="departamento" required
                             placeholder="Ej: Cundinamarca">
                    </div>

                    <!-- Ciudad -->
                    <div class="col-md-3">
                      <label for="ciudad" class="form-label">Ciudad/Municipio *</label>
                      <input type="text" class="form-control" id="ciudad" name="ciudad" required
                             placeholder="Ej: Fusagasugá">
                    </div>

                    <!-- Dirección -->
                    <div class="col-12">
                      <label for="direccionFinca" class="form-label">Dirección</label>
                      <input type="text" class="form-control" id="direccionFinca" name="direccionFinca"
                             placeholder="Vereda, Finca, Km, etc.">
                    </div>

                    <!-- Coordenadas GPS -->
                    <div class="col-md-6">
                      <label for="latitud" class="form-label">Latitud (GPS)</label>
                      <input type="number" step="0.000001" class="form-control" id="latitud" name="latitud"
                             placeholder="Ej: 4.338889">
                    </div>

                    <div class="col-md-6">
                      <label for="longitud" class="form-label">Longitud (GPS)</label>
                      <input type="number" step="0.000001" class="form-control" id="longitud" name="longitud"
                             placeholder="Ej: -74.360278">
                    </div>

                    <!-- Certificaciones (opcionales) -->
                    <div class="col-12">
                      <h6 class="text-muted mt-2">Certificaciones (Opcional)</h6>
                    </div>

                    <div class="col-md-6">
                      <label for="certificadoBPA" class="form-label">Certificado BPA</label>
                      <input type="text" class="form-control" id="certificadoBPA" name="certificadoBPA"
                             placeholder="Número de certificado">
                    </div>

                    <div class="col-md-6">
                      <label for="registroICA" class="form-label">Registro ICA</label>
                      <input type="text" class="form-control" id="registroICA" name="registroICA"
                             placeholder="Número de registro">
                    </div>


                  </div>

                  <!-- Botones de Acción -->
                  <div class="d-flex gap-2 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="cancelarFormularioFinca()">
                      <i class="bi bi-x-lg"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                      <i class="bi bi-check-lg"></i> Guardar Finca
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Listado de Fincas Existentes -->
          <div id="listadoFincas" class="row g-3">
            <!-- Se llenará dinámicamente con JavaScript -->
            <div class="col-12 text-center text-muted py-5">
              <i class="bi bi-geo-alt fs-1 d-block mb-2"></i>
              <p>Haz clic en "Agregar Finca" para registrar tu primera finca.</p>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- FAB: enlace a crear producto -->
  <a th:href="@{/productor/crear}" class="fab" role="button" title="Crear nuevo producto">
    <i class="bi bi-plus-lg"></i>
  </a>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script principal -->
  <script>
    /* ============================ */
    /*   INICIALIZACIÓN AL CARGAR   */
    /* ============================ */
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('btnToggle');
      if (btn) {
        btn.addEventListener('click', function(){
          var sb = document.getElementById('sidebar');
          if (sb) sb.classList.toggle('collapsed');
        });
      }

      /* ============================ */
      /*    BÚSQUEDA EN TIEMPO REAL   */
      /* ============================ */
      var searchBox = document.getElementById('searchBox');
      var tableRows = document.querySelectorAll('#seccionProductos tbody tr');
      if (searchBox) {
        searchBox.addEventListener('input', function(){
          var searchTerm = (this.value || '').toLowerCase();
          for (var i = 0; i < tableRows.length; i++) {
            var row = tableRows[i];
            var nameEl = row.querySelector('td:nth-child(2) strong');
            var catEl = row.querySelector('td:nth-child(3)');
            var productName = nameEl ? (nameEl.textContent || '').toLowerCase() : '';
            var category = catEl ? (catEl.textContent || '').toLowerCase() : '';
            if (productName.indexOf(searchTerm) !== -1 || category.indexOf(searchTerm) !== -1) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          }
        });
      }

      // Asegurar que los items del sidebar con data-section respondan al clic
      var sidebarItems = document.querySelectorAll('#sidebar .nav-item[data-section]');
      sidebarItems.forEach(function(item){
        item.addEventListener('click', function(e){
          var sec = item.getAttribute('data-section');
          if (sec) {
            window.cambiarSeccion(sec);
          }
        });
      });


      /* ============================ */
      /*  FORMULARIO DE FINCAS        */
      /* ============================ */
      // Configurar event listener del formulario de fincas
      var formFinca = document.getElementById('formCrearFinca');
      if (formFinca) {
        formFinca.addEventListener('submit', function(e) {
          e.preventDefault();

          // Recopilar datos del formulario
          var formData = {
            nombreFinca: document.getElementById('nombreFinca').value,
            departamento: document.getElementById('departamento').value,
            ciudad: document.getElementById('ciudad').value,
            direccionFinca: document.getElementById('direccionFinca').value,
            latitud: document.getElementById('latitud').value || null,
            longitud: document.getElementById('longitud').value || null,
            certificadoBPA: document.getElementById('certificadoBPA').value || 'Sin Certificado',
            registroICA: document.getElementById('registroICA').value || 'Sin Certificado'
          };

          // Validar nombre de finca
          if (!formData.nombreFinca || formData.nombreFinca.trim() === '') {
            alert('Por favor ingresa el nombre de la finca.');
            return;
          }

          // Enviar al backend
          fetch('/productos/fincas/crear', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          })
          .then(function(response) {
            if (!response.ok) {
              return response.json().then(function(err) {
                throw new Error(err.error || 'Error al crear la finca');
              });
            }
            return response.json();
          })
          .then(function(data) {
            // Mostrar mensaje de éxito con estilo Bootstrap
            var seccionFincas = document.getElementById('seccionFincas');
            var alertaExito = document.createElement('div');
            alertaExito.className = 'alert alert-success alert-dismissible fade show';
            alertaExito.role = 'alert';
            alertaExito.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i><strong>¡Finca creada exitosamente!</strong><br>' +
                                    '<small>' + (data.message || 'Ahora puedes asociar productos al crearlos.') + '</small>' +
                                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

            // Insertar alerta al inicio de la sección
            seccionFincas.insertBefore(alertaExito, seccionFincas.firstChild);

            // Auto-remover alerta después de 5 segundos
            setTimeout(function() {
              if (alertaExito.parentNode) {
                alertaExito.classList.remove('show');
                setTimeout(function() {
                  alertaExito.remove();
                }, 150);
              }
            }, 5000);

            // Cerrar formulario y recargar lista
            cancelarFormularioFinca();
            cargarFincas();

            // Scroll suave hacia arriba para ver la alerta
            seccionFincas.scrollIntoView({ behavior: 'smooth', block: 'start' });
          })
          .catch(function(error) {
            console.error('Error:', error);

            // Mostrar alerta de error
            var seccionFincas = document.getElementById('seccionFincas');
            var alertaError = document.createElement('div');
            alertaError.className = 'alert alert-danger alert-dismissible fade show';
            alertaError.role = 'alert';
            alertaError.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Error al crear la finca</strong><br>' +
                                   '<small>' + error.message + '</small>' +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

            seccionFincas.insertBefore(alertaError, seccionFincas.firstChild);

            // Auto-remover alerta después de 5 segundos
            setTimeout(function() {
              if (alertaError.parentNode) {
                alertaError.classList.remove('show');
                setTimeout(function() {
                  alertaError.remove();
                }, 150);
              }
            }, 5000);
          });
        });
      }
    }); // Cierre del DOMContentLoaded


    /* ================================================ */
    /*  CAMBIO DE SECCIÓN (Productos/Pedidos/Fincas)  */
    /*  FUNCIONES GLOBALES (fuera de DOMContentLoaded) */
    /* ================================================ */
    window.cambiarSeccion = function(seccion) {
      // Ocultar todas las secciones
      document.getElementById('seccionProductos').style.display = 'none';
      document.getElementById('seccionPedidos').style.display = 'none';
      document.getElementById('seccionFincas').style.display = 'none';

      // Quitar clase activar de todos los nav-items
      var navItems = document.querySelectorAll('.nav-item');
      for (var i = 0; i < navItems.length; i++) {
        navItems[i].classList.remove('active');
      }

      // Mostrar la sección seleccionada y marcar como activa
      if (seccion === 'productos') {
        document.getElementById('seccionProductos').style.display = 'block';
        document.querySelector('[data-section="productos"]').classList.add('active');
      } else if (seccion === 'pedidos') {
        document.getElementById('seccionPedidos').style.display = 'block';
        document.querySelector('[data-section="pedidos"]').classList.add('active');
        // Cargar pedidos automáticamente al entrar
        cargarPedidos();
      } else if (seccion === 'fincas') {
        document.getElementById('seccionFincas').style.display = 'block';
        document.querySelector('[data-section="fincas"]').classList.add('active');
        // Cargar fincas automáticamente al entrar
        cargarFincas();
      }
    }

    // Si el stub guardó una sección pendiente antes de que el script real se cargara, ejecutarla ahora
    if (window.__pending_cambiarSeccion) {
      try {
        var __s = window.__pending_cambiarSeccion;
        window.__pending_cambiarSeccion = null;
        // Ejecutar en el siguiente tick para asegurar que el DOM esté listo
        setTimeout(function(){ window.cambiarSeccion(__s); }, 0);
      } catch (err) {
        console.warn('No se pudo procesar sección pendiente:', err);
      }
    }

    /* ================================================ */
    /*  CARGAR PEDIDOS VÍA AJAX                        */
    /* ================================================ */
    var pedidosCargados = false;
    window.cargarPedidos = function() {
      if (pedidosCargados) {
        // Si ya se cargaron, solo refrescar
        console.log('Pedidos ya cargados, refrescando...');
      }

      var loadingEl = document.getElementById('pedidosLoading');
      var tableBodyEl = document.getElementById('pedidosTableBody');

      loadingEl.style.display = 'block';
      tableBodyEl.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm text-success"></div> Cargando...</td></tr>';

      fetch('/productos/pedidos/json')
        .then(function(response) {
          if (!response.ok) throw new Error('Error al cargar pedidos');
          return response.json();
        })
        .then(function(compras) {
          loadingEl.style.display = 'none';
          pedidosCargados = true;

          // Guardar cache global de pedidos para poder mostrar detalles rápidamente
          window._pedidosCache = compras || [];

          if (!compras || compras.length === 0) {
            tableBodyEl.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No hay pedidos para mostrar.</td></tr>';
            return;
          }

          var html = '';
          for (var i = 0; i < compras.length; i++) {
            var c = compras[i];
            var clienteNombre = c.cliente && c.cliente.nombre ? c.cliente.nombre : 'Sin nombre';
            var clienteCorreo = c.cliente && c.cliente.correo ? c.cliente.correo : '';
            var fechaTexto = c.fechaHoraCompra ? new Date(c.fechaHoraCompra).toLocaleString('es-CO') : '—';
            var totalFormato = c.total ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(c.total) : '$0';

            html += '<tr>';
            html += '<td>' + c.idCompra + '</td>';
            html += '<td><div>' + clienteNombre + '</div><small class="text-muted">' + clienteCorreo + '</small></td>';
            html += '<td>' + fechaTexto + '</td>';
            html += '<td>' + (c.direccionEntrega || '—') + '</td>';
            html += '<td><strong>' + totalFormato + '</strong></td>';
            html += '<td>' + (c.metodoPago || '—') + '</td>';
            html += '<td><button class="btn btn-sm btn-outline-primary" onclick="verDetallePedido(' + c.idCompra + ')" title="Ver detalle"><i class="bi bi-eye"></i></button></td>';
            html += '</tr>';
          }
          tableBodyEl.innerHTML = html;
        })
        .catch(function(error) {
          loadingEl.style.display = 'none';
          console.error('Error:', error);
          tableBodyEl.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle fs-1 d-block mb-2"></i>Error al cargar pedidos: ' + error.message + '</td></tr>';
        });
    }

    window.verDetallePedido = function(idCompra) {
      try {
        var modalEl = document.getElementById('modalDetallePedido');
        var modal = new bootstrap.Modal(modalEl);

        // Reset contenido y mostrar spinner
        document.getElementById('detalleSpinner').style.display = 'block';
        document.getElementById('detalleContenido').style.display = 'none';
        document.getElementById('detalleItemsBody').innerHTML = '';

        // Obtener datos básicos desde la cache si está disponible
        var compraBasica = null;
        if (window._pedidosCache && Array.isArray(window._pedidosCache)) {
          compraBasica = window._pedidosCache.find(function(x){ return x.idCompra == idCompra; });
        }

        if (compraBasica) {
          document.getElementById('detalleId').textContent = compraBasica.idCompra || idCompra;
          document.getElementById('detalleCliente').textContent = 'Cliente: ' + (compraBasica.cliente ? (compraBasica.cliente.nombre || '') : '—');
          document.getElementById('detalleFecha').textContent = 'Fecha: ' + (compraBasica.fechaHoraCompra ? new Date(compraBasica.fechaHoraCompra).toLocaleString('es-CO') : '—');
          document.getElementById('detalleDireccion').textContent = 'Dirección: ' + (compraBasica.direccionEntrega || '—');
          document.getElementById('detalleMetodoPago').textContent = 'Pago: ' + (compraBasica.metodoPago || '—');
          document.getElementById('detalleTotal').textContent = compraBasica.total ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(compraBasica.total) : '$0';
        } else {
          document.getElementById('detalleId').textContent = idCompra;
        }

        // Cargar detalles vía AJAX desde el endpoint REST
        fetch('/api/detalles-compra?idCompra=' + encodeURIComponent(idCompra))
          .then(function(res){ if(!res.ok) throw new Error('Error al cargar detalle'); return res.json(); })
          .then(function(detalles){
            // detalles es una lista de DetalleCompra; intentar renderizar
            var itemsHtml = '';
            if (Array.isArray(detalles) && detalles.length > 0) {
              detalles.forEach(function(d){
                var nombre = (d.producto && (d.producto.nombreProducto || d.producto.nombre)) || d.nombreProducto || 'Producto';
                // Intentar sacar precio y cantidad
                var precio = d.precioUnitario || (d.producto && d.producto.precio) || d.precio || 0;
                var cantidad = d.cantidad || d.cantidadProducto || 1;
                var subtotal = (parseFloat(precio) || 0) * (parseFloat(cantidad) || 0);
                var precioFmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(precio || 0);
                var subtotalFmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(subtotal || 0);

                itemsHtml += '<tr>' +
                  '<td>' + (nombre || '-') + '</td>' +
                  '<td class="text-end">' + precioFmt + '</td>' +
                  '<td class="text-end">' + cantidad + '</td>' +
                  '<td class="text-end">' + subtotalFmt + '</td>' +
                  '</tr>';
              });
            } else {
              itemsHtml = '<tr><td colspan="4" class="text-center text-muted py-3">No hay items para este pedido.</td></tr>';
            }

            document.getElementById('detalleItemsBody').innerHTML = itemsHtml;
            document.getElementById('detalleSpinner').style.display = 'none';
            document.getElementById('detalleContenido').style.display = 'block';

            modal.show();
          })
          .catch(function(err){
            console.error('Error al cargar detalles:', err);
            document.getElementById('detalleSpinner').style.display = 'none';
            document.getElementById('detalleItemsBody').innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">Error al cargar detalles: ' + (err.message || '') + '</td></tr>';
            document.getElementById('detalleContenido').style.display = 'block';
            modal.show();
          });

      } catch (e) {
        console.error('verDetallePedido error:', e);
        alert('No se pudo mostrar el detalle del pedido.');
      }
    };
  </script>

  <!-- Variable global de productos (sin inline para evitar errores de serialización) -->
  <script>
    // Los productos se cargan directamente desde el DOM, no desde inline JavaScript
    // Esto evita errores de serialización circular con entidades JPA
    window.productosDelServidor = [];

    // Si necesitas datos de productos en JavaScript, usa el endpoint JSON:
    // fetch('/productos/api/listar').then(r => r.json()).then(data => { ... });
  </script>

  <!-- Modal: Detalle de Pedido -->
  <div class="modal fade" id="modalDetallePedido" tabindex="-1" aria-labelledby="modalDetallePedidoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalDetallePedidoLabel">Detalle del pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="detallePedidoPlaceholder">
            <div class="text-center py-4" id="detalleSpinner">
              <div class="spinner-border text-success" role="status"></div>
              <div class="mt-2 text-muted">Cargando detalle...</div>
            </div>
            <div id="detalleContenido" style="display:none;">
              <!-- Encabezado con información básica -->
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 id="detalleTitulo">Pedido #<span id="detalleId">-</span></h6>
                    <div id="detalleCliente" class="small text-muted">Cliente: -</div>
                    <div id="detalleFecha" class="small text-muted">Fecha: -</div>
                  </div>
                  <div class="text-end">
                    <div id="detalleMetodoPago" class="small text-muted">Pago: -</div>
                    <div id="detalleDireccion" class="small text-muted">Dirección: -</div>
                  </div>
                </div>
              </div>

              <!-- Tabla de items -->
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th class="text-end">Precio</th>
                      <th class="text-end">Cantidad</th>
                      <th class="text-end">Subtotal</th>
                    </tr>
                  </thead>
                  <tbody id="detalleItemsBody">
                  </tbody>
                </table>
              </div>

              <div class="d-flex justify-content-end mt-3">
                <div class="text-end">
                  <div class="small text-muted">Total</div>
                  <div class="fw-bold fs-5" id="detalleTotal">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de edición rápida -->
  <div class="modal fade" id="modalEditarProducto" tabindex="-1" aria-labelledby="modalEditarProductoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarProductoLabel">Editar producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="modalAlertPlaceholder"></div>
          <form id="formEditarProducto">
            <input type="hidden" id="editProductoId" />
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input id="editNombre" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea id="editDescripcion" class="form-control" rows="3"></textarea>
            </div>
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Precio</label>
                <input id="editPrecio" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Stock</label>
                <input id="editStock" type="number" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Peso (kg)</label>
                <input id="editPeso" type="number" step="0.01" class="form-control" />
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">Categoría</label>
              <select id="editCategoria" class="form-select">
                <option value="">-- Sin categoría --</option>
                <th:block th:each="cat : ${categorias}">
                  <option th:value="${cat.idCategoria}" th:text="${cat.nombreCategoria}"></option>
                </th:block>
              </select>
            </div>

            <div class="mt-3">
              <label class="form-label">Fincas asociadas</label>
              <div class="d-flex flex-wrap gap-2" id="editFincasContainer">
                <th:block th:each="f : ${fincas}">
                  <div class="form-check">
                    <input class="form-check-input edit-finca-checkbox" type="checkbox" th:id="${'finca-'+f.idFinca}" th:value="${f.idFinca}" />
                    <label class="form-check-label" th:for="${'finca-'+f.idFinca}" th:text="${f.nombreFinca}"></label>
                  </div>
                </th:block>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="btnGuardarEdicion" type="button" class="btn btn-primary">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Abre el modal y carga los datos del producto vía AJAX
    function abrirModalEditar(id) {
      var modalEl = document.getElementById('modalEditarProducto');
      var modal = new bootstrap.Modal(modalEl);
      // Limpiar estado previo
      document.getElementById('modalAlertPlaceholder').innerHTML = '';
      document.getElementById('formEditarProducto').reset();
      // Llenar con carga desde API
      fetch('/productos/api/' + id)
        .then(function(res) { if (!res.ok) throw new Error('Producto no encontrado'); return res.json(); })
        .then(function(data) {
          document.getElementById('editProductoId').value = data.idProducto || '';
          document.getElementById('editNombre').value = data.nombreProducto || '';
          document.getElementById('editDescripcion').value = data.descripcionProducto || '';
          document.getElementById('editPrecio').value = data.precio || '';
          document.getElementById('editStock').value = data.stock || '';
          document.getElementById('editPeso').value = data.pesoKg || '';
          // Categoria
          try { document.getElementById('editCategoria').value = data.categoria ? data.categoria.id : ''; } catch (e) {}
          // Fincas: marcar checkboxes
          try {
            var fincaIds = Array.isArray(data.fincaIds) ? data.fincaIds.map(String) : [];
            var checkboxes = document.querySelectorAll('.edit-finca-checkbox');
            checkboxes.forEach(function(cb) { cb.checked = fincaIds.indexOf(cb.value) !== -1; });
          } catch (e) {}

          modal.show();
        })
        .catch(function(err) {
          alert('Error al cargar producto: ' + err.message);
        });
    }

    // Manejar envío del formulario de edición
    document.addEventListener('DOMContentLoaded', function() {
      var btnGuardar = document.getElementById('btnGuardarEdicion');
      if (!btnGuardar) return;
      btnGuardar.addEventListener('click', function() {
        var id = document.getElementById('editProductoId').value;
        if (!id) return;
        // Evitar envíos dobles: deshabilitar botón y mostrar spinner
        var originalHtml = btnGuardar.innerHTML;
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando...';

        var payload = {
          nombreProducto: document.getElementById('editNombre').value,
          descripcionProducto: document.getElementById('editDescripcion').value,
          precio: document.getElementById('editPrecio').value,
          stock: document.getElementById('editStock').value,
          pesoKg: document.getElementById('editPeso').value,
          categoriaId: document.getElementById('editCategoria').value || null,
          fincaIds: Array.from(document.querySelectorAll('.edit-finca-checkbox:checked')).map(function(cb){ return parseInt(cb.value); })
        };

        fetch('/productos/api/actualizar/' + id, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(function(res) {
          // Usar res.text() para soportar respuestas con body vacío y evitar "Unexpected end of JSON input"
          return res.text().then(function(text){
            var body = {};
            if (text && text.trim().length > 0) {
              try {
                body = JSON.parse(text);
              } catch (e) {
                // Si no es JSON, conservar el texto bruto
                body = { __raw: text };
              }
            }
            return { ok: res.ok, status: res.status, body: body };
          });
        })
        .then(function(res) {
          if (!res.ok) {
            var msg = 'Error al actualizar';
            if (res.body) {
              msg = res.body.error || res.body.message || (res.body.__raw || msg);
            }
            throw new Error(msg + ' (status ' + res.status + ')');
          }
          // Cerrar modal y recargar para ver cambios (simple y seguro)
          var modalEl = document.getElementById('modalEditarProducto');
          var modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();
          // Mostrar alerta de éxito y recargar
          location.reload();
        })
        .catch(function(err) {
          var ph = document.getElementById('modalAlertPlaceholder');
          ph.innerHTML = '<div class="alert alert-danger">Error: ' + (err.message || err) + '</div>';
          // Restaurar estado del botón para permitir reintento
          btnGuardar.disabled = false;
          btnGuardar.innerHTML = originalHtml;
        });
      });
    });
  </script>

 </body>
 </html>
