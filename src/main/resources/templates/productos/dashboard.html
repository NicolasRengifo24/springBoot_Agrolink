<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Productor — Agrolink Premium</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --green: #2f6b31;
      --green-light: #3f8a41;
      --muted: #7e8b7e;
      --glass: rgba(255,255,255,0.75);
    }

    body{
      font-family: "Inter", sans-serif;
      background: linear-gradient(180deg,#f8faf7,#f1f4ef);
      color:#222;
    }

    /* GRID LAYOUT */
    .app{
      display:grid;
      grid-template-columns:260px 1fr;
      gap:30px;
      max-width:1450px;
      margin:40px auto;
      padding:0 20px;
    }

    /* SIDEBAR */
    .sidebar{
      background:var(--glass);
      backdrop-filter:blur(12px);
      border-radius:20px;
      border:1px solid rgba(0,0,0,0.05);
      height:calc(100vh - 80px);
      padding:20px;
      position:sticky;
      top:40px;
      transition:.25s;
    }

    .sidebar.collapsed{
      width:76px;
      padding:20px 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:22px;
    }

    .brand img{
      width:42px;
      height:42px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--green);
      display:block;
      background:#fff;
    }

    .brand-title{
      font-weight:800;
      color:var(--green);
      font-size:1.3rem;
    }

    .nav-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      margin-bottom:6px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      transition:.2s;
    }

    .nav-item:hover{
      background:rgba(47,107,49,0.07);
      transform:translateX(4px);
    }

    .nav-item.active{
      background:var(--green);
      color:white;
      box-shadow:0 8px 18px rgba(47,107,49,0.25);
    }

    .nav-item .bi{
      font-size:1.1rem;
      color:var(--green);
    }

    .nav-item.active .bi{
      color:white;
    }

    .sidebar.collapsed .nav-label{
      display:none;
    }

    /* TOPBAR */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      gap:10px;
    }

    .searchbar{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 18px;
      border-radius:16px;
      background:white;
      border:1px solid #e3e9e2;
      box-shadow:0 4px 14px rgba(0,0,0,0.05);
    }

    /* CARD GLASS */
    .card-glass{
      background:white;
      border-radius:20px;
      padding:22px;
      border:1px solid rgba(0,0,0,0.05);
      box-shadow:0 12px 26px rgba(0,0,0,0.06);
      margin-bottom:20px;
    }

    /* KPIs */
    .kpi{
      padding:20px;
      border-radius:16px;
      background:white;
      box-shadow:0 8px 18px rgba(0,0,0,0.05);
      border:1px solid #edf2ec;
      transition:.2s;
    }
    .kpi:hover{
      transform:translateY(-4px);
      box-shadow:0 12px 26px rgba(0,0,0,0.09);
    }

    .kpi-icon{
      font-size:2rem;
      color:var(--green);
    }

    .kpi-number{
      font-size:1.9rem;
      font-weight:700;
    }

    .kpi-label{
      color:var(--muted);
      font-size:.9rem;
    }

    /* TABLE */
    table img.thumb{
      width:58px;
      height:58px;
      border-radius:10px;
      object-fit:cover;
      object-position:center;
      border:1px solid #eee;
      display:block;
    }


    /* FAB */
    .fab{
      position:fixed;
      right:40px;
      bottom:40px;
      width:70px;
      height:70px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--green),var(--green-light));
      border:none;
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.7rem;
      box-shadow:0 12px 30px rgba(47,107,49,0.28);
      cursor:pointer;
      transition:.2s;
    }
    .fab:hover{
      transform:translateY(-7px) scale(1.03);
    }

    /* ANIMATIONS */
    .fade{
      animation:fadeUp .4s ease both;
    }
    @keyframes fadeUp{
      from{opacity:0;transform:translateY(14px);}
      to{opacity:1;transform:translateY(0);}
    }

    .alert-custom {
      border-radius: 12px;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
  </style>
</head>

<body>

  <div class="app">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar">

      <div class="d-flex justify-content-between align-items-center">
        <div class="brand">
          <img th:src="@{/CSS/logo/logoAgro.jpeg}"
               alt="Logo Agrolink"
               style="width:42px; height:42px; border-radius:50%; object-fit:cover; border:2px solid var(--green);"
               onerror="this.style.display='none';">
          <div>
            <div class="brand-title">Agrolink</div>
            <div class="small text-muted">Productor</div>
          </div>
        </div>

        <button id="btnToggle" class="btn btn-light btn-sm">
          <i class="bi bi-list"></i>
        </button>
      </div>

      <nav>
        <div class="nav-item active" data-section="productos" onclick="cambiarSeccion('productos')">
          <i class="bi bi-box-seam"></i><span class="nav-label"> Productos</span>
        </div>
        <div class="nav-item" data-section="pedidos" onclick="cambiarSeccion('pedidos')">
          <i class="bi bi-receipt"></i><span class="nav-label"> Pedidos</span>
        </div>
        <div class="nav-item" data-section="fincas" onclick="cambiarSeccion('fincas')">
          <i class="bi bi-geo-alt-fill"></i><span class="nav-label"> Fincas</span>
        </div>
      </nav>

    </aside>

    <!-- MAIN CONTENT -->
    <main>

      <!-- TOPBAR -->
      <div class="topbar">

        <div class="searchbar">
          <i class="bi bi-search fs-5 text-muted"></i>
          <label for="searchBox" class="visually-hidden">Buscar producto</label>
          <input id="searchBox" class="form-control border-0" placeholder="Buscar producto..."/>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary"><i class="bi bi-bell"></i></button>
          <img src="https://i.pravatar.cc/40?img=12" alt="Perfil de usuario" class="rounded-circle" width="40">
        </div>

      </div>

      <!-- ALERTAS -->
      <div th:if="${success}" class="alert alert-success alert-custom alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:switch="${success}">
          <span th:case="'created'">Producto creado exitosamente</span>
          <span th:case="'updated'">Producto actualizado exitosamente</span>
          <span th:case="'deleted'">Producto eliminado exitosamente</span>
          <span th:case="*" th:text="${success}">Operación exitosa</span>
        </span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <div th:if="${error}" class="alert alert-danger alert-custom alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:switch="${error}">
          <span th:case="'delete_failed'">Error al eliminar el producto</span>
          <span th:case="'update_failed'">Error al actualizar el producto</span>
          <span th:case="'has_orders'">No se puede eliminar: el producto tiene pedidos asociados</span>
          <span th:case="*" th:text="${error}">Error en la operación</span>
        </span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <!-- ============================================ -->
      <!-- SECCIÓN PRODUCTOS (visible por defecto)    -->
      <!-- ============================================ -->
      <div id="seccionProductos">
        <!-- KPIs -->
        <div class="row g-3 mb-4 fade">

          <div class="col-md-3">
            <div class="kpi">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="kpi-number" th:text="${productos.size()}">0</div>
                  <div class="kpi-label">Productos</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-box-seam-fill"></i></div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="kpi">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="kpi-number">382</div>
                  <div class="kpi-label">Pedidos (mes)</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-cart-check-fill"></i></div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="kpi">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="kpi-number">$4.2M</div>
                  <div class="kpi-label">Ingresos</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-currency-dollar"></i></div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="kpi">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="kpi-number">98%</div>
                  <div class="kpi-label">Satisfacción</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-heart-fill"></i></div>
              </div>
            </div>
          </div>

        </div>

        <!-- CHART -->
        <div class="card-glass fade">
          <h5 class="mb-3">Ventas últimos 6 meses</h5>
          <canvas id="chartSales" style="max-height:300px;"></canvas>
        </div>

        <!-- PRODUCTOS -->
        <div class="card-glass fade">
          <div class="d-flex justify-content-between">
            <h5>Mis Productos</h5>
            <!-- Enlace a la página de creación separada -->
            <a th:href="@{/productos/crear}" class="btn btn-success">
              <i class="bi bi-plus-lg"></i> Crear producto
            </a>
          </div>

          <div class="table-responsive mt-3">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Producto</th>
                  <th>Categoría</th>
                  <th>Finca(s)</th>
                  <th>Stock</th>
                  <th>Precio</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="producto : ${productos}">
                  <td>
                    <!-- Mostrar imagen principal si existe, o placeholder si no -->
                    <img class="thumb"
                         th:alt="${producto.nombreProducto}"
                         th:src="${producto.imagenesProducto != null and !producto.imagenesProducto.isEmpty() ? producto.imagenesProducto[0].urlImagen : '/imag/placeholder.jpg'}"
                         onerror="this.onerror=null; this.src='/imag/placeholder.jpg';" />
                  </td>
                  <td>
                    <strong th:text="${producto.nombreProducto}">Nombre</strong><br>
                    <small class="text-muted" th:text="${'ID: ' + producto.idProducto}">ID: 1</small>
                  </td>
                  <td th:text="${producto.categoria != null ? producto.categoria.nombreCategoria : 'Sin categoría'}">Categoría</td>
                  <td>
                    <!-- Mostrar fincas asociadas -->
                    <th:block th:if="${producto.productoFincas != null and #lists.size(producto.productoFincas) > 0}">
                      <th:block th:each="pf, iterStat : ${producto.productoFincas}">
                        <span th:if="${iterStat.index < 2 and pf != null and pf.finca != null}"
                              class="badge bg-success-subtle text-success me-1 mb-1"
                              th:text="${pf.finca.nombreFinca}"
                              th:title="${pf.finca.nombreFinca}">
                          Finca
                        </span>
                      </th:block>
                      <span th:if="${#lists.size(producto.productoFincas) > 2}"
                            class="badge bg-secondary-subtle text-secondary">
                        + más
                      </span>
                    </th:block>
                    <small class="text-muted" th:if="${producto.productoFincas == null or #lists.size(producto.productoFincas) == 0}">
                      <i class="bi bi-dash-circle"></i> Sin finca
                    </small>
                  </td>
                  <td th:text="${producto.stock}">0</td>
                  <td>
                    <strong th:text="${#numbers.formatCurrency(producto.precio)}">$0</strong>
                  </td>
                  <td class="text-end">
                    <!-- Enlace único para editar en la página separada -->
                    <a th:href="@{/productos/editar/{id}(id=${producto.idProducto})}" class="btn btn-sm btn-outline-primary me-1" title="Editar">
                      <i class="bi bi-pencil"></i>
                    </a>
                     <form th:action="@{/productos/eliminar/{id}(id=${producto.idProducto})}"
                           method="post"
                           style="display:inline;"
                           onsubmit="return confirm('¿Está seguro de eliminar este producto?');">
                       <button type="submit" class="btn btn-sm btn-outline-danger">
                         <i class="bi bi-trash"></i>
                       </button>
                     </form>
                   </td>
                </tr>

                <tr th:if="${productos == null || productos.isEmpty()}">
                  <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No hay productos registrados. Crea tu primer producto.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECCIÓN PEDIDOS (oculta inicialmente)      -->
      <!-- ============================================ -->
      <div id="seccionPedidos" style="display:none;">
        <div class="card-glass fade">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Pedidos recibidos</h5>
            <button class="btn btn-outline-secondary btn-sm" onclick="cargarPedidos()">
              <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
          </div>

          <div id="pedidosLoading" class="text-center py-5" style="display:none;">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando pedidos...</p>
          </div>

          <div class="table-responsive" id="tablaPedidos">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Fecha</th>
                  <th>Dirección</th>
                  <th>Total</th>
                  <th>Método Pago</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="pedidosTableBody">
                <!-- Se llenará dinámicamente con JavaScript -->
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    Haz clic en "Actualizar" para cargar los pedidos.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECCIÓN FINCAS (oculta inicialmente)       -->
      <!-- ============================================ -->
      <div id="seccionFincas" style="display:none;">
        <div class="card-glass fade">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Mis Fincas</h5>
            <button class="btn btn-success btn-sm" onclick="mostrarFormularioFinca()">
              <i class="bi bi-plus-lg"></i> Agregar Finca
            </button>
          </div>

          <!-- Formulario de Nueva Finca (oculto inicialmente) -->
          <div id="formularioFinca" style="display:none;" class="mb-4">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Nueva Finca</h6>
              </div>
              <div class="card-body">
                <form id="formCrearFinca">
                  <div class="row g-3">
                    <!-- Nombre de la Finca -->
                    <div class="col-md-6">
                      <label for="nombreFinca" class="form-label">Nombre de la Finca *</label>
                      <input type="text" class="form-control" id="nombreFinca" name="nombreFinca" required
                             placeholder="Ej: Finca El Paraíso">
                    </div>

                    <!-- Departamento -->
                    <div class="col-md-3">
                      <label for="departamento" class="form-label">Departamento *</label>
                      <input type="text" class="form-control" id="departamento" name="departamento" required
                             placeholder="Ej: Cundinamarca">
                    </div>

                    <!-- Ciudad -->
                    <div class="col-md-3">
                      <label for="ciudad" class="form-label">Ciudad/Municipio *</label>
                      <input type="text" class="form-control" id="ciudad" name="ciudad" required
                             placeholder="Ej: Fusagasugá">
                    </div>

                    <!-- Dirección -->
                    <div class="col-12">
                      <label for="direccionFinca" class="form-label">Dirección</label>
                      <input type="text" class="form-control" id="direccionFinca" name="direccionFinca"
                             placeholder="Vereda, Finca, Km, etc.">
                    </div>

                    <!-- Coordenadas GPS -->
                    <div class="col-md-6">
                      <label for="latitud" class="form-label">Latitud (GPS)</label>
                      <input type="number" step="0.000001" class="form-control" id="latitud" name="latitud"
                             placeholder="Ej: 4.338889">
                    </div>

                    <div class="col-md-6">
                      <label for="longitud" class="form-label">Longitud (GPS)</label>
                      <input type="number" step="0.000001" class="form-control" id="longitud" name="longitud"
                             placeholder="Ej: -74.360278">
                    </div>

                    <!-- Certificaciones (opcionales) -->
                    <div class="col-12">
                      <h6 class="text-muted mt-2">Certificaciones (Opcional)</h6>
                    </div>

                    <div class="col-md-6">
                      <label for="certificadoBPA" class="form-label">Certificado BPA</label>
                      <input type="text" class="form-control" id="certificadoBPA" name="certificadoBPA"
                             placeholder="Número de certificado">
                    </div>

                    <div class="col-md-6">
                      <label for="registroICA" class="form-label">Registro ICA</label>
                      <input type="text" class="form-control" id="registroICA" name="registroICA"
                             placeholder="Número de registro">
                    </div>


                  </div>

                  <!-- Botones de Acción -->
                  <div class="d-flex gap-2 justify-content-end mt-4">
                    <button type="button" class="btn btn-secondary" onclick="cancelarFormularioFinca()">
                      <i class="bi bi-x-lg"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                      <i class="bi bi-check-lg"></i> Guardar Finca
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Listado de Fincas Existentes -->
          <div id="listadoFincas" class="row g-3">
            <!-- Se llenará dinámicamente con JavaScript -->
            <div class="col-12 text-center text-muted py-5">
              <i class="bi bi-geo-alt fs-1 d-block mb-2"></i>
              <p>Haz clic en "Agregar Finca" para registrar tu primera finca.</p>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- FAB: enlace a crear producto -->
  <a th:href="@{/productos/crear}" class="fab" role="button" title="Crear nuevo producto">
    <i class="bi bi-plus-lg"></i>
  </a>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script principal -->
  <script>
    /* ============================ */
    /*   INICIALIZACIÓN AL CARGAR   */
    /* ============================ */
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('btnToggle');
      if (btn) {
        btn.addEventListener('click', function(){
          var sb = document.getElementById('sidebar');
          if (sb) sb.classList.toggle('collapsed');
        });
      }

      /* ============================ */
      /*    BÚSQUEDA EN TIEMPO REAL   */
      /* ============================ */
      var searchBox = document.getElementById('searchBox');
      var tableRows = document.querySelectorAll('#seccionProductos tbody tr');
      if (searchBox) {
        searchBox.addEventListener('input', function(){
          var searchTerm = (this.value || '').toLowerCase();
          for (var i = 0; i < tableRows.length; i++) {
            var row = tableRows[i];
            var nameEl = row.querySelector('td:nth-child(2) strong');
            var catEl = row.querySelector('td:nth-child(3)');
            var productName = nameEl ? (nameEl.textContent || '').toLowerCase() : '';
            var category = catEl ? (catEl.textContent || '').toLowerCase() : '';
            if (productName.indexOf(searchTerm) !== -1 || category.indexOf(searchTerm) !== -1) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          }
        });
      }

      /* ============================ */
      /*        CHART SALES           */
      /* ============================ */
      // Gráfico simple con datos de ejemplo
      var chartCanvas = document.getElementById('chartSales');
      if (chartCanvas && typeof Chart !== 'undefined') {
        new Chart(chartCanvas, {
          type: 'line',
          data: {
            labels: ['Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov'],
            datasets: [{
              label: 'Ventas COP',
              data: [12000, 22000, 18000, 26000, 30000, 42000],
              borderColor: '#2f6b31',
              backgroundColor: 'rgba(47,107,49,0.15)',
              borderWidth: 3,
              pointRadius: 5,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { display: true, position: 'top' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }

      /* ============================ */
      /*  FORMULARIO DE FINCAS        */
      /* ============================ */
      // Configurar event listener del formulario de fincas
      var formFinca = document.getElementById('formCrearFinca');
      if (formFinca) {
        formFinca.addEventListener('submit', function(e) {
          e.preventDefault();

          // Recopilar datos del formulario
          var formData = {
            nombreFinca: document.getElementById('nombreFinca').value,
            departamento: document.getElementById('departamento').value,
            ciudad: document.getElementById('ciudad').value,
            direccionFinca: document.getElementById('direccionFinca').value,
            latitud: document.getElementById('latitud').value || null,
            longitud: document.getElementById('longitud').value || null,
            certificadoBPA: document.getElementById('certificadoBPA').value || 'Sin Certificado',
            registroICA: document.getElementById('registroICA').value || 'Sin Certificado'
          };

          // Validar nombre de finca
          if (!formData.nombreFinca || formData.nombreFinca.trim() === '') {
            alert('Por favor ingresa el nombre de la finca.');
            return;
          }

          // Enviar al backend
          fetch('/productos/fincas/crear', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          })
          .then(function(response) {
            if (!response.ok) {
              return response.json().then(function(err) {
                throw new Error(err.error || 'Error al crear la finca');
              });
            }
            return response.json();
          })
          .then(function(data) {
            // Mostrar mensaje de éxito con estilo Bootstrap
            var seccionFincas = document.getElementById('seccionFincas');
            var alertaExito = document.createElement('div');
            alertaExito.className = 'alert alert-success alert-dismissible fade show';
            alertaExito.role = 'alert';
            alertaExito.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i><strong>¡Finca creada exitosamente!</strong><br>' +
                                    '<small>' + (data.message || 'Ahora puedes asociar productos al crearlos.') + '</small>' +
                                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

            // Insertar alerta al inicio de la sección
            seccionFincas.insertBefore(alertaExito, seccionFincas.firstChild);

            // Auto-remover alerta después de 5 segundos
            setTimeout(function() {
              if (alertaExito.parentNode) {
                alertaExito.classList.remove('show');
                setTimeout(function() {
                  alertaExito.remove();
                }, 150);
              }
            }, 5000);

            // Cerrar formulario y recargar lista
            cancelarFormularioFinca();
            cargarFincas();

            // Scroll suave hacia arriba para ver la alerta
            seccionFincas.scrollIntoView({ behavior: 'smooth', block: 'start' });
          })
          .catch(function(error) {
            console.error('Error:', error);

            // Mostrar alerta de error
            var seccionFincas = document.getElementById('seccionFincas');
            var alertaError = document.createElement('div');
            alertaError.className = 'alert alert-danger alert-dismissible fade show';
            alertaError.role = 'alert';
            alertaError.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Error al crear la finca</strong><br>' +
                                   '<small>' + error.message + '</small>' +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

            seccionFincas.insertBefore(alertaError, seccionFincas.firstChild);

            // Auto-remover alerta después de 5 segundos
            setTimeout(function() {
              if (alertaError.parentNode) {
                alertaError.classList.remove('show');
                setTimeout(function() {
                  alertaError.remove();
                }, 150);
              }
            }, 5000);
          });
        });
      }
    }); // Cierre del DOMContentLoaded


    /* ================================================ */
    /*  CAMBIO DE SECCIÓN (Productos/Pedidos/Fincas)  */
    /*  FUNCIONES GLOBALES (fuera de DOMContentLoaded) */
    /* ================================================ */
    window.cambiarSeccion = function(seccion) {
      // Ocultar todas las secciones
      document.getElementById('seccionProductos').style.display = 'none';
      document.getElementById('seccionPedidos').style.display = 'none';
      document.getElementById('seccionFincas').style.display = 'none';

      // Quitar clase activar de todos los nav-items
      var navItems = document.querySelectorAll('.nav-item');
      for (var i = 0; i < navItems.length; i++) {
        navItems[i].classList.remove('active');
      }

      // Mostrar la sección seleccionada y marcar como activa
      if (seccion === 'productos') {
        document.getElementById('seccionProductos').style.display = 'block';
        document.querySelector('[data-section="productos"]').classList.add('active');
      } else if (seccion === 'pedidos') {
        document.getElementById('seccionPedidos').style.display = 'block';
        document.querySelector('[data-section="pedidos"]').classList.add('active');
        // Cargar pedidos automáticamente al entrar
        cargarPedidos();
      } else if (seccion === 'fincas') {
        document.getElementById('seccionFincas').style.display = 'block';
        document.querySelector('[data-section="fincas"]').classList.add('active');
        // Cargar fincas automáticamente al entrar
        cargarFincas();
      }
    }

    /* ================================================ */
    /*  CARGAR PEDIDOS VÍA AJAX                        */
    /* ================================================ */
    var pedidosCargados = false;
    window.cargarPedidos = function() {
      if (pedidosCargados) {
        // Si ya se cargaron, solo refrescar
        console.log('Pedidos ya cargados, refrescando...');
      }

      var loadingEl = document.getElementById('pedidosLoading');
      var tableBodyEl = document.getElementById('pedidosTableBody');

      loadingEl.style.display = 'block';
      tableBodyEl.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4"><div class="spinner-border spinner-border-sm text-success"></div> Cargando...</td></tr>';

      fetch('/productos/pedidos/json')
        .then(function(response) {
          if (!response.ok) throw new Error('Error al cargar pedidos');
          return response.json();
        })
        .then(function(compras) {
          loadingEl.style.display = 'none';
          pedidosCargados = true;

          if (!compras || compras.length === 0) {
            tableBodyEl.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4"><i class="bi bi-inbox fs-1 d-block mb-2"></i>No hay pedidos para mostrar.</td></tr>';
            return;
          }

          var html = '';
          for (var i = 0; i < compras.length; i++) {
            var c = compras[i];
            var clienteNombre = c.cliente && c.cliente.nombre ? c.cliente.nombre : 'Sin nombre';
            var clienteCorreo = c.cliente && c.cliente.correo ? c.cliente.correo : '';
            var fechaTexto = c.fechaHoraCompra ? new Date(c.fechaHoraCompra).toLocaleString('es-CO') : '—';
            var totalFormato = c.total ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(c.total) : '$0';

            html += '<tr>';
            html += '<td>' + c.idCompra + '</td>';
            html += '<td><div>' + clienteNombre + '</div><small class="text-muted">' + clienteCorreo + '</small></td>';
            html += '<td>' + fechaTexto + '</td>';
            html += '<td>' + (c.direccionEntrega || '—') + '</td>';
            html += '<td><strong>' + totalFormato + '</strong></td>';
            html += '<td>' + (c.metodoPago || '—') + '</td>';
            html += '<td><button class="btn btn-sm btn-outline-primary" onclick="verDetallePedido(' + c.idCompra + ')"><i class="bi bi-eye"></i></button></td>';
            html += '</tr>';
          }
          tableBodyEl.innerHTML = html;
        })
        .catch(function(error) {
          loadingEl.style.display = 'none';
          console.error('Error:', error);
          tableBodyEl.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle fs-1 d-block mb-2"></i>Error al cargar pedidos: ' + error.message + '</td></tr>';
        });
    }

    window.verDetallePedido = function(idCompra) {
      alert('Ver detalle del pedido #' + idCompra + '\n\n(Puedes implementar un modal o navegar a otra vista)');
      // TODO: implementar modal o redirección para ver detalles
    };

    /* ================================================ */
    /*  GESTIÓN DE FINCAS                              */
    /* ================================================ */
    window.mostrarFormularioFinca = function() {
      var formulario = document.getElementById('formularioFinca');
      formulario.style.display = 'block';
      formulario.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    window.cancelarFormularioFinca = function() {
      document.getElementById('formularioFinca').style.display = 'none';
      document.getElementById('formCrearFinca').reset();
    };


    /* ================================================ */
    /*  CARGAR FINCAS - FUNCIÓN GLOBAL                */
    /* ================================================ */
    window.cargarFincas = function() {
      var container = document.getElementById('listadoFincas');
      container.innerHTML = '<div class="col-12 text-center text-muted py-3">' +
                           '<div class="spinner-border spinner-border-sm text-success me-2"></div>' +
                           '<span>Cargando fincas...</span></div>';

      fetch('/productos/fincas/listar')
        .then(function(response) {
          if (!response.ok) throw new Error('Error al cargar fincas');
          return response.json();
        })
        .then(function(fincas) {
          console.log('Fincas cargadas:', fincas); // Debug

          if (!fincas || fincas.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted py-5">' +
                                 '<i class="bi bi-geo-alt fs-1 d-block mb-2 text-success"></i>' +
                                 '<h6 class="mb-2">No tienes fincas registradas</h6>' +
                                 '<p class="small">Haz clic en "Agregar Finca" para registrar tu primera finca.</p></div>';
            return;
          }

          var html = '';
          for (var i = 0; i < fincas.length; i++) {
            var finca = fincas[i];
            var cantidadProductos = finca.cantidadProductos || 0;

            html += '<div class="col-md-6">';
            html += '<div class="card border-0 shadow-sm h-100">';
            html += '<div class="card-body">';
            html += '<div class="d-flex justify-content-between align-items-start mb-3">';
            html += '<div>';
            html += '<h6 class="fw-bold mb-1 text-success">' + (finca.nombreFinca || 'Sin nombre') + '</h6>';
            html += '<small class="text-muted"><i class="bi bi-geo-alt me-1"></i>' + (finca.departamento || '') + ', ' + (finca.ciudad || '') + '</small>';
            html += '</div>';
            html += '<span class="badge bg-success">Activa</span>';
            html += '</div>';
            html += '<div class="row g-2 mb-3">';
            html += '<div class="col-6"><small class="text-muted d-block">Dirección</small><strong class="small">' + (finca.direccionFinca || '—') + '</strong></div>';
            html += '<div class="col-6"><small class="text-muted d-block">Productos asociados</small><strong>' + cantidadProductos + '</strong></div>';
            html += '</div>';

            // Información adicional si existe
            if (finca.certificadoBPA && finca.certificadoBPA !== 'Sin Certificado') {
              html += '<div class="mb-2"><small class="badge bg-info-subtle text-info"><i class="bi bi-patch-check"></i> BPA: ' + finca.certificadoBPA + '</small></div>';
            }

            html += '<div class="d-flex gap-2 mt-3">';
            html += '<button class="btn btn-sm btn-outline-primary flex-fill" onclick="verDetalleFinca(' + finca.idFinca + ')"><i class="bi bi-eye"></i> Ver</button>';
            html += '<button class="btn btn-sm btn-outline-secondary" title="Editar finca"><i class="bi bi-pencil"></i></button>';
            html += '</div>';
            html += '</div></div></div>';
          }
          container.innerHTML = html;
        })
        .catch(function(error) {
          console.error('Error al cargar fincas:', error);
          container.innerHTML = '<div class="col-12">' +
                               '<div class="alert alert-danger">' +
                               '<i class="bi bi-exclamation-triangle me-2"></i>' +
                               '<strong>Error al cargar fincas:</strong> ' + error.message +
                               '</div></div>';
        });
    }

    window.verDetalleFinca = function(idFinca) {
      alert('Ver detalle de la finca #' + idFinca + '\n\n(Funcionalidad en desarrollo)');
      // TODO: Implementar vista de detalle con productos asociados
    };
  </script>

  <!-- Script separado con Thymeleaf inline para cargar productos -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    // Variable global con productos desde el servidor
    window.productosDelServidor = /*[[${productos}]]*/ [];
    /*]]>*/
  </script>

</body>
</html>
